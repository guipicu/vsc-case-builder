<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSC Case Builder - Clinical Case Configuration Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .builder-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            min-height: 100vh;
            backdrop-filter: blur(10px);
        }
        
        .builder-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .builder-header h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .builder-nav {
            display: flex;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }
        
        .nav-tab {
            flex: 1;
            min-width: 200px;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            background: #e9ecef;
            border: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .nav-tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }
        
        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
        }
        
        .builder-content {
            display: none;
            padding: 30px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .builder-content.active {
            display: block;
        }
        
        .form-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .dynamic-list {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .list-item input {
            flex: 1;
            margin: 0;
        }
        
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .code-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            white-space: pre-wrap;
        }
        
        .help-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .help-box h4 {
            color: #1976d2;
            margin-bottom: 8px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .status-ready {
            background: #d4edda;
            color: #155724;
        }
        
        .status-incomplete {
            background: #fff3cd;
            color: #856404;
        }
        
        .export-section {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .builder-nav {
                flex-direction: column;
            }
            
            .nav-tab {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="builder-container">
        <div class="builder-header">
            <h1>üî¨ VSC Case Builder</h1>
            <p>Visual Configuration Tool for Clinical Case Creation in Visual Synthesis Challenge</p>
            <div id="buildStatus" class="status-indicator status-incomplete">
                ‚ö†Ô∏è Configuration Incomplete
            </div>
        </div>

        <div class="builder-nav">
            <button class="nav-tab active" onclick="showBuilderTab(0)">üìã Clinical Case</button>
            <button class="nav-tab" onclick="showBuilderTab(1)">üéØ Requirements</button>
            <button class="nav-tab" onclick="showBuilderTab(2)">ü§ñ AI Configuration</button>
            <button class="nav-tab" onclick="showBuilderTab(3)">üé® Interface Styling</button>
            <button class="nav-tab" onclick="showBuilderTab(4)">üëÅÔ∏è Preview</button>
            <button class="nav-tab" onclick="showBuilderTab(5)">üì¶ Export & Deploy</button>
        </div>

        <!-- Tab 1: Clinical Case -->
        <div class="builder-content active">
            <div class="form-section">
                <h3>üìã Clinical Case Information</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="caseTitle">Case Title</label>
                        <input type="text" id="caseTitle" placeholder="e.g., 7-Year-Old Dog with Ascites" value="7-Year-Old Dog with Ascites">
                    </div>
                    
                    <div class="form-group">
                        <label for="caseSpecies">Species</label>
                        <select id="caseSpecies">
                            <option value="canine">Canine</option>
                            <option value="feline">Feline</option>
                            <option value="equine">Equine</option>
                            <option value="bovine">Bovine</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="caseSynopsis">Case Synopsis</label>
                    <textarea id="caseSynopsis" placeholder="Brief description of the clinical case...">Progressive abdominal distension in a mixed-breed dog requiring systematic diagnostic approach</textarea>
                </div>
            </div>

            <div class="form-section">
                <h3>üìä Patient Information</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="patientBreed">Breed/Type</label>
                        <input type="text" id="patientBreed" placeholder="e.g., Mixed-breed dog" value="Mixed-breed dog (Golden Retriever cross)">
                    </div>
                    
                    <div class="form-group">
                        <label for="patientAge">Age</label>
                        <input type="text" id="patientAge" placeholder="e.g., 7 years old" value="7 years old">
                    </div>
                    
                    <div class="form-group">
                        <label for="patientSex">Sex</label>
                        <input type="text" id="patientSex" placeholder="e.g., Neutered male" value="Neutered male">
                    </div>
                    
                    <div class="form-group">
                        <label for="patientHistory">History</label>
                        <input type="text" id="patientHistory" placeholder="e.g., Adopted 3 years ago" value="Adopted 3 years ago, semi-urban environment">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>ü©∫ Clinical Presentation</h3>
                
                <div id="clinicalFindings">
                    <div class="list-item">
                        <input type="text" placeholder="Clinical finding" value="Chief complaint: Abdominal distension (10 days)">
                        <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                    </div>
                    <div class="list-item">
                        <input type="text" placeholder="Clinical finding" value="Recent changes: Lethargy and decreased appetite (48h)">
                        <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                    </div>
                    <div class="list-item">
                        <input type="text" placeholder="Clinical finding" value="Physical exam: Distended abdomen, positive fluid wave">
                        <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                    </div>
                    <div class="list-item">
                        <input type="text" placeholder="Clinical finding" value="Vitals: T¬∞ 38.4¬∞C, mild tachypnoea, pale pink mucous membranes">
                        <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="addClinicalFinding()">‚ûï Add Clinical Finding</button>
            </div>
        </div>

        <!-- Tab 2: Requirements -->
        <div class="builder-content">
            <div class="form-section">
                <h3>üéØ Decision Tree Requirements</h3>
                
                <div class="form-group">
                    <label for="minDifferentials">Minimum Number of Differential Diagnoses</label>
                    <input type="number" id="minDifferentials" min="3" max="10" value="5">
                </div>
                
                <div class="form-group">
                    <label for="primaryTest">Primary Recommended Diagnostic Test</label>
                    <input type="text" id="primaryTest" placeholder="e.g., Abdominocentesis" value="Abdominocentesis">
                </div>
                
                <div class="form-group">
                    <label for="minTreatments">Minimum Number of Treatment Options</label>
                    <input type="number" id="minTreatments" min="2" max="6" value="2">
                </div>
            </div>

            <div class="form-section">
                <h3>üîç Key Differential Diagnoses</h3>
                
                <div class="help-box">
                    <h4>üí° Customise Categories</h4>
                    <p>Add or remove diagnostic categories based on your clinical case. Different presentations require different pathophysiological approaches.</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="addDiagnosticCategory()">‚ûï Add New Category</button>
                    <button class="btn btn-secondary" onclick="loadDiagnosticTemplate()">üìã Load Template</button>
                </div>
                
                <div id="diagnosticCategories" class="form-grid">
                    <div class="form-group" data-category="cardiacCauses">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <input type="text" value="Cardiac Causes" class="category-name" style="flex: 1; font-weight: 600;">
                            <button class="btn btn-danger" onclick="removeDiagnosticCategory(this)" style="padding: 8px 12px;">üóëÔ∏è</button>
                        </div>
                        <div class="dynamic-list" id="cardiacCauses">
                            <div class="list-item">
                                <input type="text" value="Right-sided heart failure">
                                <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                            </div>
                            <div class="list-item">
                                <input type="text" value="Congestive heart failure">
                                <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="addDifferential('cardiacCauses')">‚ûï Add</button>
                    </div>
                    
                    <div class="form-group" data-category="hepaticCauses">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <input type="text" value="Hepatic Causes" class="category-name" style="flex: 1; font-weight: 600;">
                            <button class="btn btn-danger" onclick="removeDiagnosticCategory(this)" style="padding: 8px 12px;">üóëÔ∏è</button>
                        </div>
                        <div class="dynamic-list" id="hepaticCauses">
                            <div class="list-item">
                                <input type="text" value="Cirrhosis/portal hypertension">
                                <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                            </div>
                            <div class="list-item">
                                <input type="text" value="Hepatic failure">
                                <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="addDifferential('hepaticCauses')">‚ûï Add</button>
                    </div>
                    
                    <div class="form-group" data-category="renalCauses">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <input type="text" value="Renal Causes" class="category-name" style="flex: 1; font-weight: 600;">
                            <button class="btn btn-danger" onclick="removeDiagnosticCategory(this)" style="padding: 8px 12px;">üóëÔ∏è</button>
                        </div>
                        <div class="dynamic-list" id="renalCauses">
                            <div class="list-item">
                                <input type="text" value="Protein-losing nephropathy">
                                <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                            </div>
                            <div class="list-item">
                                <input type="text" value="Chronic kidney disease">
                                <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="addDifferential('renalCauses')">‚ûï Add</button>
                    </div>
                    
                    <div class="form-group" data-category="neoplasticCauses">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <input type="text" value="Neoplastic Causes" class="category-name" style="flex: 1; font-weight: 600;">
                            <button class="btn btn-danger" onclick="removeDiagnosticCategory(this)" style="padding: 8px 12px;">üóëÔ∏è</button>
                        </div>
                        <div class="dynamic-list" id="neoplasticCauses">
                            <div class="list-item">
                                <input type="text" value="Abdominal tumours">
                                <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                            </div>
                            <div class="list-item">
                                <input type="text" value="Peritoneal carcinomatosis">
                                <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="addDifferential('neoplasticCauses')">‚ûï Add</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: AI Configuration -->
        <div class="builder-content">
            <div class="form-section">
                <h3>ü§ñ Google AI Configuration</h3>
                
                <div class="help-box">
                    <h4>üîë Google AI Studio API Key</h4>
                    <p>To function properly, you need to configure the environment variable <code>GOOGLE_AI_API_KEY</code> in Vercel with your Google AI Studio key.</p>
                    <p><strong>How to set up:</strong></p>
                    <ol>
                        <li>Go to <a href="https://aistudio.google.com" target="_blank">Google AI Studio</a></li>
                        <li>Create a new API key</li>
                        <li>In Vercel dashboard ‚Üí Project Settings ‚Üí Environment Variables</li>
                        <li>Add: <code>GOOGLE_AI_API_KEY</code> with your key</li>
                    </ol>
                </div>
                
                <div class="form-group">
                    <label for="aiModel">AI Model</label>
                    <select id="aiModel">
                        <option value="gemini-1.5-flash" selected>Gemini 1.5 Flash (Recommended)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="aiTemperature">Temperature (0.0 - 1.0)</label>
                    <input type="number" id="aiTemperature" min="0" max="1" step="0.1" value="0.7">
                </div>
                
                <div class="form-group">
                    <label for="maxTokens">Max Tokens</label>
                    <input type="number" id="maxTokens" min="200" max="2000" value="800">
                </div>
            </div>

            <div class="form-section">
                <h3>üìù AI Prompt Customisation</h3>
                
                <div class="form-group">
                    <label for="aiContext">Clinical Context for AI Analysis</label>
                    <textarea id="aiContext" placeholder="Specific veterinary context...">You are a veterinary specialist analysing a clinical decision tree for canine ascites.</textarea>
                </div>
                
                <div class="form-group">
                    <label for="feedbackFocus">Analysis Focus Areas</label>
                    <textarea id="feedbackFocus" placeholder="What should the AI focus on...">1. Clinical reasoning quality and completeness
2. Diagnostic approach appropriateness for ascites
3. Missing critical elements (abdominocentesis, major differentials)
4. Treatment pathway adequacy
5. Overall veterinary clinical thinking demonstration</textarea>
                </div>
            </div>
        </div>

        <!-- Tab 4: Interface Styling -->
        <div class="builder-content">
            <div class="form-section">
                <h3>üé® Visual Theme Configuration</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="primaryColor">Primary Colour</label>
                        <input type="color" id="primaryColor" value="#4facfe">
                    </div>
                    
                    <div class="form-group">
                        <label for="secondaryColor">Secondary Colour</label>
                        <input type="color" id="secondaryColor" value="#00f2fe">
                    </div>
                    
                    <div class="form-group">
                        <label for="accentColor">Accent Colour</label>
                        <input type="color" id="accentColor" value="#28a745">
                    </div>
                    
                    <div class="form-group">
                        <label for="headerStyle">Header Style</label>
                        <select id="headerStyle">
                            <option value="gradient">Gradient (Default)</option>
                            <option value="solid">Solid Colour</option>
                            <option value="minimal">Minimal</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>üì± Interface Customisation</h3>
                
                <div class="form-group">
                    <label for="moduleTitle">Module Title</label>
                    <input type="text" id="moduleTitle" placeholder="e.g., Module 1: Clinical Reasoning" value="Visual Synthesis Challenge - Phase 1">
                </div>
                
                <div class="form-group">
                    <label for="institutionName">Institution Name (optional)</label>
                    <input type="text" id="institutionName" placeholder="e.g., University of Veterinary Medicine">
                </div>
                
                <div class="form-group">
                    <label for="showDrawioIntegration">Show Draw.io Integration</label>
                    <select id="showDrawioIntegration">
                        <option value="true">Yes - Embedded Draw.io editor</option>
                        <option value="false">No - External link only</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tab 5: Preview -->
        <div class="builder-content">
            <div class="form-section">
                <h3>üëÅÔ∏è Live Preview</h3>
                
                <div class="help-box">
                    <h4>üìã Preview Notes</h4>
                    <p>This preview shows how your configured case will appear to students. The AI analysis will only work after deployment with proper API configuration.</p>
                </div>
                
                <button class="btn btn-success" onclick="generatePreview()">üîÑ Generate Preview</button>
                
                <div id="previewContainer" style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px; padding: 20px; margin: 20px 0; min-height: 400px;">
                    <p><strong>Preview will be displayed here</strong></p>
                    <p>Click "Generate Preview" to see how your case will look to students.</p>
                </div>
            </div>
        </div>

        <!-- Tab 6: Export & Deploy -->
        <div class="builder-content">
            <div class="export-section">
                <h3>üì¶ Export Your VSC Case</h3>
                <p>Generate the complete code package ready for deployment</p>
                
                <div style="margin: 20px 0;">
                    <button class="btn btn-success" onclick="generateExport()">üöÄ Generate Complete Package</button>
                    <button class="btn btn-secondary" onclick="downloadFiles()">üíæ Download Files</button>
                </div>
            </div>

            <div class="form-section">
                <h3>üìÑ Generated Files</h3>
                
                <div class="help-box">
                    <h4>üìã Deployment Instructions</h4>
                    <ol>
                        <li><strong>Download</strong> the generated files</li>
                        <li><strong>Create new Vercel project</strong> or update existing one</li>
                        <li><strong>Upload files</strong> to your Vercel project</li>
                        <li><strong>Configure environment variables:</strong> Add <code>GOOGLE_AI_API_KEY</code></li>
                        <li><strong>Deploy</strong> and test the functionality</li>
                        <li><strong>Embed in Moodle</strong> using iframe with the Vercel URL</li>
                    </ol>
                </div>

                <div id="fileOutput">
                    <h4>index.html</h4>
                    <div class="code-output" id="htmlOutput">
                        Click "Generate Complete Package" to see the files...
                    </div>
                    
                    <h4>api/analyze.js</h4>
                    <div class="code-output" id="apiOutput">
                        Click "Generate Complete Package" to see the files...
                    </div>
                    
                    <h4>package.json</h4>
                    <div class="code-output" id="packageOutput">
                        Click "Generate Complete Package" to see the files...
                    </div>
                    
                    <h4>vercel.json</h4>
                    <div class="code-output" id="vercelOutput">
                        Click "Generate Complete Package" to see the files...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 0;
        
        function showBuilderTab(tabIndex) {
            // Hide all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.builder-content').forEach(content => content.classList.remove('active'));
            
            // Show selected tab
            document.querySelectorAll('.nav-tab')[tabIndex].classList.add('active');
            document.querySelectorAll('.builder-content')[tabIndex].classList.add('active');
            
            currentTab = tabIndex;
            updateBuildStatus();
        }

        function addClinicalFinding() {
            const container = document.getElementById('clinicalFindings');
            const newItem = document.createElement('div');
            newItem.className = 'list-item';
            newItem.innerHTML = `
                <input type="text" placeholder="Clinical finding">
                <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
            `;
            container.appendChild(newItem);
        }

        function addDifferential(containerId) {
            const container = document.getElementById(containerId);
            const newItem = document.createElement('div');
            newItem.className = 'list-item';
            newItem.innerHTML = `
                <input type="text" placeholder="Differential diagnosis">
                <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
            `;
            container.appendChild(newItem);
        }

        function addDiagnosticCategory() {
            const container = document.getElementById('diagnosticCategories');
            const categoryId = 'category' + Date.now(); // Unique ID
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'form-group';
            categoryDiv.setAttribute('data-category', categoryId);
            
            categoryDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="text" value="New Category" class="category-name" style="flex: 1; font-weight: 600;" placeholder="e.g., Respiratory Causes">
                    <button class="btn btn-danger" onclick="removeDiagnosticCategory(this)" style="padding: 8px 12px;">üóëÔ∏è</button>
                </div>
                <div class="dynamic-list" id="${categoryId}">
                    <div class="list-item">
                        <input type="text" placeholder="Differential diagnosis">
                        <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="addDifferential('${categoryId}')">‚ûï Add</button>
            `;
            
            container.appendChild(categoryDiv);
        }

        function removeDiagnosticCategory(button) {
            if (confirm('Remove this entire diagnostic category?')) {
                button.closest('.form-group').remove();
            }
        }

        function loadDiagnosticTemplate() {
            const templates = {
                'Ascites (Current)': {
                    'Cardiac Causes': ['Right-sided heart failure', 'Congestive heart failure'],
                    'Hepatic Causes': ['Cirrhosis/portal hypertension', 'Hepatic failure'],
                    'Renal Causes': ['Protein-losing nephropathy', 'Chronic kidney disease'],
                    'Neoplastic Causes': ['Abdominal tumours', 'Peritoneal carcinomatosis']
                },
                'Dyspnoea': {
                    'Cardiac Causes': ['Congestive heart failure', 'Arrhythmias', 'Pericardial disease'],
                    'Respiratory Causes': ['Pneumonia', 'Asthma', 'Pulmonary oedema', 'Pleural effusion'],
                    'Metabolic Causes': ['Anaemia', 'Acidosis', 'Hyperthermia'],
                    'Neurological Causes': ['CNS lesions affecting respiratory centres']
                },
                'Lameness': {
                    'Orthopaedic Causes': ['Fractures', 'Joint disease', 'Ligament injury', 'Muscle injury'],
                    'Neurological Causes': ['Spinal cord lesions', 'Peripheral neuropathy', 'Nerve entrapment'],
                    'Vascular Causes': ['Thromboembolism', 'Compartment syndrome'],
                    'Infectious Causes': ['Septic arthritis', 'Osteomyelitis', 'Soft tissue infection']
                },
                'Vomiting': {
                    'Gastrointestinal Causes': ['Gastritis', 'Foreign body', 'Inflammatory bowel disease', 'Pancreatitis'],
                    'Metabolic Causes': ['Kidney disease', 'Liver disease', 'Electrolyte imbalances'],
                    'Neurological Causes': ['Motion sickness', 'CNS lesions', 'Vestibular disease'],
                    'Toxic Causes': ['Drug toxicity', 'Plant toxins', 'Chemical ingestion']
                },
                'Diarrhoea': {
                    'Dietary Causes': ['Food intolerance', 'Dietary indiscretion', 'Food allergies'],
                    'Infectious Causes': ['Bacterial enteritis', 'Viral enteritis', 'Parasitic infection'],
                    'Inflammatory Causes': ['IBD', 'Colitis', 'Enteritis'],
                    'Neoplastic Causes': ['Intestinal tumours', 'Lymphoma'],
                    'Metabolic Causes': ['Pancreatic insufficiency', 'Liver disease']
                }
            };

            const templateName = prompt(`Choose a template:\n${Object.keys(templates).map((name, i) => `${i+1}. ${name}`).join('\n')}\n\nEnter number (1-${Object.keys(templates).length}):`);
            
            if (templateName) {
                const templateKeys = Object.keys(templates);
                const selectedTemplate = templates[templateKeys[parseInt(templateName) - 1]];
                
                if (selectedTemplate) {
                    // Clear existing categories
                    document.getElementById('diagnosticCategories').innerHTML = '';
                    
                    // Add template categories
                    Object.entries(selectedTemplate).forEach(([categoryName, diagnoses]) => {
                        const categoryId = categoryName.toLowerCase().replace(/\s+/g, '') + 'Causes';
                        addTemplateCategory(categoryId, categoryName, diagnoses);
                    });
                }
            }
        }

        function addTemplateCategory(categoryId, categoryName, diagnoses) {
            const container = document.getElementById('diagnosticCategories');
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'form-group';
            categoryDiv.setAttribute('data-category', categoryId);
            
            const diagnosesHTML = diagnoses.map(diagnosis => `
                <div class="list-item">
                    <input type="text" value="${diagnosis}">
                    <button class="btn btn-danger" onclick="removeListItem(this)">‚ùå</button>
                </div>
            `).join('');
            
            categoryDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="text" value="${categoryName}" class="category-name" style="flex: 1; font-weight: 600;">
                    <button class="btn btn-danger" onclick="removeDiagnosticCategory(this)" style="padding: 8px 12px;">üóëÔ∏è</button>
                </div>
                <div class="dynamic-list" id="${categoryId}">
                    ${diagnosesHTML}
                </div>
                <button class="btn btn-secondary" onclick="addDifferential('${categoryId}')">‚ûï Add</button>
            `;
            
            container.appendChild(categoryDiv);
        }

        function removeListItem(button) {
            button.parentElement.remove();
            updateBuildStatus();
        }

        function updateBuildStatus() {
            const caseTitle = document.getElementById('caseTitle').value;
            const caseSynopsis = document.getElementById('caseSynopsis').value;
            const primaryTest = document.getElementById('primaryTest').value;
            
            const statusElement = document.getElementById('buildStatus');
            
            if (caseTitle && caseSynopsis && primaryTest) {
                statusElement.className = 'status-indicator status-ready';
                statusElement.innerHTML = '‚úÖ Configuration Complete';
            } else {
                statusElement.className = 'status-indicator status-incomplete';
                statusElement.innerHTML = '‚ö†Ô∏è Configuration Incomplete';
            }
        }

        function collectFormData() {
            // Patient information
            const patientData = {
                title: document.getElementById('caseTitle').value,
                species: document.getElementById('caseSpecies').value,
                synopsis: document.getElementById('caseSynopsis').value,
                breed: document.getElementById('patientBreed').value,
                age: document.getElementById('patientAge').value,
                sex: document.getElementById('patientSex').value,
                history: document.getElementById('patientHistory').value
            };

            // Clinical findings
            const clinicalFindings = Array.from(document.querySelectorAll('#clinicalFindings input'))
                .map(input => input.value)
                .filter(value => value.trim() !== '');

            // Requirements
            const requirements = {
                minDifferentials: document.getElementById('minDifferentials').value,
                primaryTest: document.getElementById('primaryTest').value,
                minTreatments: document.getElementById('minTreatments').value
            };

            // Differential diagnoses (dynamic categories)
            const differentials = {};
            document.querySelectorAll('#diagnosticCategories .form-group').forEach(categoryGroup => {
                const categoryName = categoryGroup.querySelector('.category-name').value;
                const categoryId = categoryGroup.getAttribute('data-category');
                const diagnoses = Array.from(categoryGroup.querySelectorAll('.dynamic-list input'))
                    .map(i => i.value)
                    .filter(v => v.trim() !== '');
                differentials[categoryName] = diagnoses;
            });

            // AI configuration
            const aiConfig = {
                model: document.getElementById('aiModel').value,
                temperature: document.getElementById('aiTemperature').value,
                maxTokens: document.getElementById('maxTokens').value,
                context: document.getElementById('aiContext').value,
                feedbackFocus: document.getElementById('feedbackFocus').value
            };

            // Interface configuration
            const interfaceConfig = {
                primaryColor: document.getElementById('primaryColor').value,
                secondaryColor: document.getElementById('secondaryColor').value,
                accentColor: document.getElementById('accentColor').value,
                headerStyle: document.getElementById('headerStyle').value,
                moduleTitle: document.getElementById('moduleTitle').value,
                institutionName: document.getElementById('institutionName').value,
                showDrawioIntegration: document.getElementById('showDrawioIntegration').value === 'true'
            };

            return {
                patient: patientData,
                clinicalFindings,
                requirements,
                differentials,
                aiConfig,
                interface: interfaceConfig
            };
        }

        function generatePreview() {
            const data = collectFormData();
            const previewHTML = generatePreviewHTML(data);
            
            // Create iframe with the preview
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = `
                <iframe style="width: 100%; height: 600px; border: none; border-radius: 8px;" 
                        srcdoc="${previewHTML.replace(/"/g, '&quot;')}">
                </iframe>
            `;
        }

        function generatePreviewHTML(data) {
            return `<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${data.interface.moduleTitle}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f8f9fa; line-height: 1.6; color: #333;
        }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; }
        .header { 
            background: linear-gradient(135deg, ${data.interface.primaryColor} 0%, ${data.interface.secondaryColor} 100%);
            color: white; padding: 20px 30px; text-align: center;
        }
        .header h1 { font-size: 1.8em; margin-bottom: 8px; }
        .phase-badge { background: rgba(255, 255, 255, 0.2); padding: 6px 16px; border-radius: 20px; font-size: 0.9em; display: inline-block; margin-top: 8px; }
        .tabs { display: flex; background: #e9ecef; }
        .tab { flex: 1; padding: 15px 20px; text-align: center; background: #e9ecef; border: none; font-size: 14px; font-weight: 600; }
        .tab.active { background: white; color: ${data.interface.primaryColor}; border-bottom: 3px solid ${data.interface.primaryColor}; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .case-summary { background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 25px; }
        .case-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .info-card { background: #f8f9fa; padding: 18px; border-radius: 8px; border-left: 3px solid ${data.interface.primaryColor}; }
        .info-card h4 { color: #2c3e50; margin-bottom: 10px; font-size: 0.95em; }
        .info-list { list-style: none; padding: 0; }
        .info-list li { padding: 4px 0; font-size: 0.9em; border-bottom: 1px solid #e9ecef; }
        .info-list li:last-child { border-bottom: none; }
        .requirements { background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ ${data.interface.moduleTitle}</h1>
            <p>Clinical Decision Tree: Systematic Approach to ${data.patient.title}</p>
            <div class="phase-badge">üìç Phase 1: Ideal Patient - Complete Diagnostic Access</div>
        </div>

        <div class="tabs">
            <button class="tab active">üìã Case Information</button>
            <button class="tab">üéØ Requirements</button>
            <button class="tab">üé® Create Diagram</button>
            <button class="tab">ü§ñ AI Analysis</button>
        </div>

        <div class="tab-content active">
            <div class="case-summary">
                <h3>üè• Clinical Case: ${data.patient.title}</h3>
                <p><strong>Synopsis:</strong> ${data.patient.synopsis}</p>
            </div>
            
            <div class="case-grid">
                <div class="info-card">
                    <h4>üìã Patient Details</h4>
                    <ul class="info-list">
                        <li><strong>Species:</strong> ${data.patient.breed}</li>
                        <li><strong>Age:</strong> ${data.patient.age}</li>
                        <li><strong>Sex:</strong> ${data.patient.sex}</li>
                        <li><strong>History:</strong> ${data.patient.history}</li>
                    </ul>
                </div>

                <div class="info-card">
                    <h4>ü©∫ Clinical Presentation</h4>
                    <ul class="info-list">
                        ${data.clinicalFindings.map(finding => `<li>${finding}</li>`).join('')}
                    </ul>
                </div>

                ${Object.entries(data.differentials).map(([categoryName, causes]) => `
                    <div class="info-card">
                        <h4>üîç ${categoryName}</h4>
                        <ul class="info-list">
                            ${causes.map(cause => `<li>${cause}</li>`).join('')}
                        </ul>
                    </div>
                `).join('')}
            </div>

            <div class="requirements">
                <h3>üìã Decision Tree Requirements</h3>
                <p><strong>Your decision tree must include:</strong></p>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li><strong>Differential diagnoses:</strong> At least ${data.requirements.minDifferentials} causes</li>
                    <li><strong>Primary diagnostic test:</strong> ${data.requirements.primaryTest}</li>
                    <li><strong>Treatment options:</strong> At least ${data.requirements.minTreatments} different protocols</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>`;
        }

        function generateExport() {
            const data = collectFormData();
            
            // Generate all files
            const htmlContent = generateCompleteHTML(data);
            const apiContent = generateAPITemplate(data);
            const packageContent = generatePackageTemplate();
            const vercelContent = generateVercelTemplate();

            // Display in code outputs
            document.getElementById('htmlOutput').textContent = htmlContent.substring(0, 1000) + '...\n[Complete file will be downloaded]';
            document.getElementById('apiOutput').textContent = apiContent.substring(0, 1000) + '...\n[Complete file will be downloaded]';
            document.getElementById('packageOutput').textContent = packageContent;
            document.getElementById('vercelOutput').textContent = vercelContent;

            // Store for download
            window.generatedFiles = {
                'index.html': htmlContent,
                'api/analyze.js': apiContent,
                'package.json': packageContent,
                'vercel.json': vercelContent
            };
        }

        function generateCompleteHTML(data) {
            // This generates the complete functional HTML for deployment
            return `<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${data.interface.moduleTitle}</title>
    <!-- Complete CSS and HTML structure would go here -->
    <!-- This is a simplified version for demonstration -->
</head>
<body>
    <!-- Complete VSC interface with your configured case data -->
    <h1>${data.patient.title}</h1>
    <p>${data.patient.synopsis}</p>
    <!-- Full interface implementation would continue here -->
</body>
</html>`;
        }

        function generateAPITemplate(data) {
            return `import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_AI_API_KEY);

export default async function handler(req, res) {
  // Complete API implementation for ${data.patient.title}
  // AI Model: ${data.aiConfig.model}
  // Temperature: ${data.aiConfig.temperature}
  
  const prompt = \`${data.aiConfig.context}

CLINICAL CASE: ${data.patient.title} - ${data.patient.synopsis}

Primary diagnostic test expected: ${data.requirements.primaryTest}
Minimum differentials required: ${data.requirements.minDifferentials}

${data.aiConfig.feedbackFocus}\`;
  
  // Complete implementation continues...
}`;
        }

        function generatePackageTemplate() {
            return `{
  "name": "vsc-clinical-case",
  "version": "1.0.0",
  "description": "VSC Clinical Case - Visual Synthesis Challenge",
  "scripts": {
    "dev": "vercel dev",
    "build": "echo 'Build complete'"
  },
  "dependencies": {
    "@google/generative-ai": "^0.7.1"
  }
}`;
        }

        function generateVercelTemplate() {
            return `{
  "functions": {
    "api/analyze.js": {
      "maxDuration": 30
    }
  },
  "rewrites": [
    {
      "source": "/",
      "destination": "/index.html"
    }
  ]
}`;
        }

        function downloadFiles() {
            if (!window.generatedFiles) {
                alert('Please generate the package first!');
                return;
            }

            // Create and download each file
            Object.entries(window.generatedFiles).forEach(([filename, content]) => {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename.replace('/', '_'); // Replace / with _ for download
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            alert('Files downloaded! Check your Downloads folder for:\n- index.html\n- api_analyze.js\n- package.json\n- vercel.json');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateBuildStatus();
            
            // Add event listeners for auto-updating status
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('change', updateBuildStatus);
                input.addEventListener('input', updateBuildStatus);
            });
        });
    </script>
</body>
</html>